<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/css/flashcards.css" />
    <title>Flashcards - PROBATIO</title>
  </head>
  <body>
    <!-- HEADER ATUALIZADO -->
    <header>
      <div id="header_esquerda">
        <a href="/inicio" id="logo">PROBATIO</a>

        <div class="nav-principal">
          <!-- Link de Matérias - será mostrado apenas para bolsistas -->
          <a
            href="/material"
            class="nav-link bolsista-only"
            id="link-materias"
            style="display: none"
            >Material</a
          >
          <a href="/teste_es" class="nav-link">Estatísticas</a>
          <a href="/flashcards" class="nav-link">Flashcards</a>
          <a href="/noticias" class="nav-link">Portais de Notícia</a>
          <a href="/pomodoro" class="nav-link">Pomodoro</a>
          <a href="" class="nav-link">Temporizador</a>
        </div>

        <div class="menu-usuario">
          <a href="/perfil" class="nav-link">
            <img src="/images/user.png" alt="Perfil" class="icon" />
          </a>
          <a href="/logout" class="nav-link">Sair</a>
        </div>
      </div>
    </header>

    <div id="container">
      <main>
        <h1>Flashcards</h1>

        <div class="filtros">
          <button class="filtro-btn ativo" data-materia="todas">Todas</button>
          <button class="filtro-btn" data-materia="matematica">
            Matemática
          </button>
          <button class="filtro-btn" data-materia="linguagens">
            Linguagens
          </button>
          <button class="filtro-btn" data-materia="humanas">
            Ciências Humanas
          </button>
          <button class="filtro-btn" data-materia="natureza">
            Ciências da Natureza
          </button>
        </div>

        <div class="flashcard-container" id="flashcardsContainer">
          <!-- Flashcards serão carregados dinamicamente via JavaScript -->
        </div>
        <div class="estatisticas">
          <h2>Seu Desempenho</h2>
          <div class="stats-grid">
            <div class="stat-card">
              <h3>Matemática</h3>
              <p id="stat-matematica">0/0</p>
            </div>
            <div class="stat-card">
              <h3>Linguagens</h3>
              <p id="stat-linguagens">0/0</p>
            </div>
            <div class="stat-card">
              <h3>Ciências Humanas</h3>
              <p id="stat-humanas">0/0</p>
            </div>
            <div class="stat-card">
              <h3>Ciências da Natureza</h3>
              <p id="stat-natureza">0/0</p>
            </div>
          </div>
        </div>
      </main>

      <div class="linha">
        <hr />
      </div>

      <footer>
        <div class="logofinal">
          <a href="#inicio" id="logo">PROBATIO</a>
        </div>
      </footer>
    </div>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // CARREGAR DADOS DO USUÁRIO E VERIFICAR SE É BOLSISTA
        fetch("/api/usuario")
          .then((response) => response.json())
          .then((data) => {
            // Verificar se o usuário é bolsista e mostrar o link de Matérias
            if (data.tipo === "BOLSISTA") {
              const linkMaterias = document.getElementById("link-materias");
              linkMaterias.style.display = "block";
            }
          })
          .catch((error) => {
            console.error("Erro ao carregar dados do usuário:", error);
          });

        // Carregar flashcards do banco de dados
        loadFlashcardsFromDB();

        // Configurar filtros
        const filtroBtns = document.querySelectorAll(".filtro-btn");
        filtroBtns.forEach((btn) => {
          btn.addEventListener("click", () => {
            // Remove a classe ativo de todos os botões
            filtroBtns.forEach((b) => b.classList.remove("ativo"));
            // Adiciona a classe ativo ao botão clicado
            btn.classList.add("ativo");
            const materia = btn.getAttribute("data-materia");
            filterFlashcards(materia);
          });
        });

        // Inicializar estatísticas
        updateStatsDisplay();

        async function loadFlashcardsFromDB() {
          try {
            const response = await fetch("/api/todos-flashcards");
            const flashcards = await response.json();

            const container = document.getElementById("flashcardsContainer");
            container.innerHTML = "";

            if (flashcards.length === 0) {
              container.innerHTML =
                '<div class="no-flashcards">Nenhum flashcard disponível no momento.</div>';
              return;
            }

            flashcards.forEach((flashcard) => {
              const flashcardElement = createFlashcardElement(flashcard);
              container.appendChild(flashcardElement);
            });

            // Re-aplicar os event listeners após carregar os flashcards
            reapplyEventListeners();
          } catch (error) {
            console.error("Erro ao carregar flashcards:", error);
            document.getElementById("flashcardsContainer").innerHTML =
              '<div class="error-message">Erro ao carregar flashcards.</div>';
          }
        }

        function mapearNomeConteudo(value) {
          const mapeamento = {
            // Ciências Humanas
            historia: "História",
            geografia: "Geografia",
            sociologia: "Sociologia",
            filosofia: "Filosofia",

            // Ciências da Natureza
            biologia: "Biologia",
            fisica: "Física",
            quimica: "Química",

            // Linguagens
            portugues: "Português",
            ingles: "Inglês",
            espanhol: "Espanhol",

            // Matemática
            matematica: "Matemática",
          };

          return mapeamento[value] || value;
        }

        function createFlashcardElement(flashcard) {
          const div = document.createElement("div");
          div.className = "flashcard";

          // Mapear a matéria para o formato usado no CSS
          const materiaMap = {
            CH: "humanas",
            CN: "natureza",
            LINGUAGENS: "linguagens",
            MATEMATICA: "matematica",
          };

          const materiaClass = materiaMap[flashcard.materia] || "humanas";
          const materiaNames = {
            CH: "Ciências Humanas",
            CN: "Ciências da Natureza",
            LINGUAGENS: "Linguagens",
            MATEMATICA: "Matemática",
          };

          div.setAttribute("data-materia", materiaClass);
          div.innerHTML = `
  <span class="materia-tag ${materiaClass}">${
            materiaNames[flashcard.materia] || flashcard.materia
          }</span>
           <div class="conteudo-tag">${mapearNomeConteudo(
             flashcard.conteudo
           )}</div>
  <div class="pergunta">${flashcard.pergunta}</div>
  <div class="resposta">${flashcard.resposta}</div>
  <div class="controles">
    <button class="btn mostrar-resposta">Mostrar Resposta</button>
    <div class="feedback-buttons" style="display: none">
      <button class="btn acertou">Acertou</button>
      <button class="btn errou">Errou</button>
    </div>
  </div>
`;

          return div;
        }

        function reapplyEventListeners() {
          // Mostrar/ocultar respostas
          const mostrarRespostaButtons =
            document.querySelectorAll(".mostrar-resposta");
          mostrarRespostaButtons.forEach((button) => {
            button.addEventListener("click", (e) => {
              const card = e.target.closest(".flashcard");
              const resposta = card.querySelector(".resposta");
              const feedbackButtons = card.querySelector(".feedback-buttons");

              resposta.style.display = "block";
              feedbackButtons.style.display = "flex";
              button.style.display = "none";
            });
          });

          // Botões de acerto/erro
          const acertouButtons = document.querySelectorAll(".acertou");
          const errouButtons = document.querySelectorAll(".errou");

          acertouButtons.forEach((button) => {
            button.addEventListener("click", (e) => {
              const card = e.target.closest(".flashcard");
              const materia = card.getAttribute("data-materia");
              registerAnswer(materia, true);
              card.style.display = "none";
            });
          });

          errouButtons.forEach((button) => {
            button.addEventListener("click", (e) => {
              const card = e.target.closest(".flashcard");
              const materia = card.getAttribute("data-materia");
              registerAnswer(materia, false);
              card.style.display = "none";
            });
          });
        }

        function filterFlashcards(materia) {
          const flashcards = document.querySelectorAll(".flashcard");
          flashcards.forEach((card) => {
            if (
              materia === "todas" ||
              card.getAttribute("data-materia") === materia
            ) {
              card.style.display = "flex";
            } else {
              card.style.display = "none";
            }
          });
        }

        async function registerAnswer(materia, acertou) {
          try {
            // Salvar no banco de dados
            await fetch("/api/estatisticas", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ materia, acertou }),
            });

            // Atualizar a exibição
            await updateStatsDisplay();
          } catch (error) {
            console.error("Erro ao registrar resposta:", error);
          }
        }
        async function updateStatsDisplay() {
          try {
            const response = await fetch("/api/estatisticas");
            const stats = await response.json();

            document.getElementById(
              "stat-matematica"
            ).textContent = `${stats.matematica.acertos}/${stats.matematica.total}`;
            document.getElementById(
              "stat-linguagens"
            ).textContent = `${stats.linguagens.acertos}/${stats.linguagens.total}`;
            document.getElementById(
              "stat-humanas"
            ).textContent = `${stats.humanas.acertos}/${stats.humanas.total}`;
            document.getElementById(
              "stat-natureza"
            ).textContent = `${stats.natureza.acertos}/${stats.natureza.total}`;
          } catch (error) {
            console.error("Erro ao carregar estatísticas:", error);
          }
        }
      });
    </script>
  </body>
</html>
