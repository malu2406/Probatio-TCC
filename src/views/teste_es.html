<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/css/teste_es.css" />
    <title>Estatísticas - PROBATIO</title>
  </head>
  <body>
    <!-- HEADER ATUALIZADO -->
    <header>
      <div id="header_esquerda">
        <a href="/inicio" id="logo">PROBATIO</a>

        <div class="nav-principal">
          <!-- Link de Matérias - será mostrado apenas para bolsistas -->
          <a
            href="/material"
            class="nav-link bolsista-only"
            id="link-materias"
            style="display: none"
            >Material</a
          >
          <a href="/teste_es" class="nav-link">Estatísticas</a>
          <a href="/flashcards" class="nav-link">Flashcards</a>
          <a href="/noticias" class="nav-link">Portais de Notícia</a>
          <a href="/pomodoro" class="nav-link">Pomodoro</a>
          <a href="" class="nav-link">Temporizador</a>
        </div>
        <div class="menu-usuario">
          <a href="/perfil" class="nav-link">
            <img src="/images/user.png" alt="Perfil" class="icon" />
          </a>
          <a href="/logout" class="nav-link">Sair</a>
        </div>
      </div>
    </header>

    <div id="container">
      <main>
        <h1>Estatísticas</h1>
        <h2>Estatísticas gerais</h2>

        <div id="stats-content">
          <!-- Conteúdo será preenchido via JavaScript -->
        </div>
      </main>

      <div class="linha">
        <hr />
      </div>

      <footer>
        <div class="logofinal">
          <a href="#inicio" id="logo">PROBATIO</a>
        </div>
      </footer>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // CARREGAR DADOS DO USUÁRIO E VERIFICAR SE É BOLSISTA
        fetch("/api/usuario")
          .then((response) => response.json())
          .then((data) => {
            if (data.tipo === "BOLSISTA") {
              const linkMaterias = document.getElementById("link-materias");
              linkMaterias.style.display = "block";

              const titulo = document.querySelector("h1");
              const badge = document.createElement("span");
              badge.className = "badge-bolsista";
              badge.textContent = "Bolsista";
              titulo.appendChild(badge);
            }
          })
          .catch((error) => {
            console.error("Erro ao carregar dados do usuário:", error);
          });

        // CARREGAR ESTATÍSTICAS DO BANCO DE DADOS
        loadEstatisticas();

        async function loadEstatisticas() {
          try {
            const response = await fetch("/api/estatisticas");
            const stats = await response.json();

            displayEstatisticas(stats);
          } catch (error) {
            console.error("Erro ao carregar estatísticas:", error);
            displayEstatisticas({
              matematica: { total: 0, acertos: 0 },
              linguagens: { total: 0, acertos: 0 },
              humanas: { total: 0, acertos: 0 },
              natureza: { total: 0, acertos: 0 },
            });
          }
        }

        function displayEstatisticas(stats) {
          const statsContent = document.getElementById("stats-content");

          // Calcular totais
          const totalQuestoes =
            stats.matematica.total +
            stats.linguagens.total +
            stats.humanas.total +
            stats.natureza.total;
          const totalAcertos =
            stats.matematica.acertos +
            stats.linguagens.acertos +
            stats.humanas.acertos +
            stats.natureza.acertos;
          const percentualGeral =
            totalQuestoes > 0
              ? Math.round((totalAcertos / totalQuestoes) * 100)
              : 0;

          if (totalQuestoes === 0) {
            statsContent.innerHTML = `
        <div class="empty-stats">
          <p>Você ainda não respondeu nenhum flashcard.</p>
          <p><a href="/flashcards">Clique aqui para começar a praticar!</a></p>
        </div>
      `;
          } else {
            statsContent.innerHTML = `
        <div class="dashboard">
          <div class="stats-card">
            <h3>Desempenho nas matérias</h3>
            <div class="materia-stats">
              ${generateMateriaStats(stats)}
            </div>
          </div>
          
          <div class="stats-card">
            <h3>Estatísticas gerais</h3>
            <div class="overall-stats">
              <div class="stat-box">
                <h4>Total de Questões</h4>
                <div class="stat-value">${totalQuestoes}</div>
              </div>
              <div class="stat-box">
                <h4>Total de Acertos</h4>
                <div class="stat-value">${totalAcertos}</div>
              </div>
              <div class="stat-box">
                <h4>Percentual Geral</h4>
                <div class="stat-value">${percentualGeral}%</div>
              </div>
            </div>
            
            <div class="chart-container" id="chart-container">
              <!-- Gráfico será gerado via JavaScript -->
            </div>
          </div>
        </div>
        
        <button class="reset-btn" id="reset-stats">Zerar Estatísticas</button>
      `;

            generateChart(stats);

            document
              .getElementById("reset-stats")
              .addEventListener("click", async function () {
                if (
                  confirm("Tem certeza que deseja zerar todas as estatísticas?")
                ) {
                  try {
                    const response = await fetch("/api/estatisticas", {
                      method: "DELETE",
                    });

                    if (response.ok) {
                      alert("Estatísticas zeradas com sucesso!");
                      loadEstatisticas();
                    } else {
                      alert("Erro ao zerar estatísticas.");
                    }
                  } catch (error) {
                    console.error("Erro:", error);
                    alert("Erro ao zerar estatísticas.");
                  }
                }
              });
          }
        }

        function generateMateriaStats(stats) {
          const materias = [
            { key: "matematica", nome: "Matemática", class: "matematica" },
            { key: "linguagens", nome: "Linguagens", class: "linguagens" },
            { key: "humanas", nome: "Ciências Humanas", class: "humanas" },
            {
              key: "natureza",
              nome: "Ciências da Natureza",
              class: "natureza",
            },
          ];

          return materias
            .map((materia) => {
              const stat = stats[materia.key];
              const percentual =
                stat.total > 0
                  ? Math.round((stat.acertos / stat.total) * 100)
                  : 0;

              return `
        <div class="materia-item">
          <div class="materia-name">
            <span class="materia-color ${materia.class}-color"></span>
            ${materia.nome}
          </div>
          <div class="materia-value">
            ${stat.acertos}/${stat.total}
            (${percentual}%)
          </div>
        </div>
        <div class="progress-bar">
          <div class="progress-fill progress-${materia.class}" style="width: ${percentual}%"></div>
        </div>
      `;
            })
            .join("");
        }

        function generateChart(stats) {
          const chartContainer = document.getElementById("chart-container");
          const percentuais = {
            matematica:
              stats.matematica.total > 0
                ? Math.round(
                    (stats.matematica.acertos / stats.matematica.total) * 100
                  )
                : 0,
            linguagens:
              stats.linguagens.total > 0
                ? Math.round(
                    (stats.linguagens.acertos / stats.linguagens.total) * 100
                  )
                : 0,
            humanas:
              stats.humanas.total > 0
                ? Math.round(
                    (stats.humanas.acertos / stats.humanas.total) * 100
                  )
                : 0,
            natureza:
              stats.natureza.total > 0
                ? Math.round(
                    (stats.natureza.acertos / stats.natureza.total) * 100
                  )
                : 0,
          };

          // Criar eixos Y
          for (let i = 0; i <= 100; i += 20) {
            const yLabel = document.createElement("div");
            yLabel.className = "axis-y-label";
            yLabel.style.bottom = `${i}%`;
            yLabel.textContent = `${100 - i}%`;
            chartContainer.appendChild(yLabel);
          }

          // Criar barras
          const materias = [
            {
              tipo: "matematica",
              nome: "Matemática",
              percentual: percentuais.matematica,
            },
            {
              tipo: "linguagens",
              nome: "Linguagens",
              percentual: percentuais.linguagens,
            },
            {
              tipo: "humanas",
              nome: "Humanas",
              percentual: percentuais.humanas,
            },
            {
              tipo: "natureza",
              nome: "Natureza",
              percentual: percentuais.natureza,
            },
          ];

          materias.forEach((materia) => {
            const bar = document.createElement("div");
            bar.className = `bar bar-${materia.tipo}`;
            bar.style.height = `${materia.percentual}%`;

            const label = document.createElement("div");
            label.className = "bar-label";
            label.textContent = `${materia.percentual}%`;
            bar.appendChild(label);

            chartContainer.appendChild(bar);
          });
        }
      });
    </script>
  </body>
</html>
