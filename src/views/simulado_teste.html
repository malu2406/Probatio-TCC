<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Simulado</title>
    <style>
      /* Estilos Gerais */
      :root {
        --primary: #4361ee;
        --primary-dark: #3a56d4;
        --secondary: #3f37c9;
        --success: #4cc9f0;
        --error: #f72585;
        --light: #f8f9fa;
        --dark: #212529;
        --gray: #6c757d;
        --border-radius: 12px;
        --box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        --transition: all 0.3s ease;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background-color: #f5f7ff;
        color: var(--dark);
        line-height: 1.6;
        min-height: 100vh;
        padding: 20px;
      }

      /* Container Principal */
      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      h1,
      h2,
      h3 {
        margin-bottom: 20px;
        color: var(--primary);
        text-align: center;
      }

      /* Cards de Seleção */
      .selection-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        margin: 30px 0;
      }

      .selection-card {
        background-color: white;
        border: 2px solid var(--primary);
        color: var(--primary);
        padding: 20px;
        border-radius: var(--border-radius);
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        box-shadow: var(--box-shadow);
        text-align: center;
      }

      .selection-card:hover {
        background-color: var(--primary);
        color: white;
        transform: translateY(-5px);
      }

      /* Questão */
      .question-container {
        background-color: white;
        border-radius: var(--border-radius);
        padding: 30px;
        margin-top: 20px;
        box-shadow: var(--box-shadow);
      }

      .question-text {
        font-size: 1.2rem;
        margin: 20px 0;
        line-height: 1.7;
        white-space: normal;
      }

      .question-text p {
        margin-bottom: 1em;
      }

      .question-image {
        max-width: 100%;
        height: auto;
        border-radius: var(--border-radius);
        margin: 20px auto;
        display: block;
      }

      /* Alternativas */
      .options-container {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin: 30px 0;
      }

      .option {
        background-color: var(--light);
        border: none;
        padding: 15px 20px;
        border-radius: var(--border-radius);
        text-align: left;
        font-size: 1rem;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
      }

      .option:hover {
        background-color: #e9ecef;
      }

      .option::before {
        content: attr(data-letter);
        display: inline-block;
        width: 30px;
        height: 30px;
        background-color: white;
        color: var(--primary);
        border-radius: 50%;
        text-align: center;
        line-height: 30px;
        margin-right: 15px;
        font-weight: bold;
      }

      .option.correct {
        background-color: rgba(76, 201, 240, 0.2);
        border-left: 4px solid var(--success);
      }

      .option.incorrect {
        background-color: rgba(247, 37, 133, 0.1);
        border-left: 4px solid var(--error);
      }

      /* Botões */
      .button {
        padding: 12px 25px;
        border-radius: var(--border-radius);
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        font-size: 1rem;
      }

      .button-primary {
        background: var(--primary);
        color: white;
      }

      .button-primary:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
      }

      .button-secondary {
        background: white;
        color: var(--primary);
        border: 2px solid var(--primary);
      }

      .button-secondary:hover {
        background: #f0f4ff;
      }

      .button-group {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
        gap: 15px;
      }

      /* Mensagens */
      #loading,
      #error-message {
        text-align: center;
        padding: 20px;
        font-size: 1.1rem;
      }

      #error-message {
        color: var(--error);
        background: rgba(247, 37, 133, 0.1);
        border-radius: var(--border-radius);
        margin: 20px 0;
        border-left: 4px solid var(--error);
      }

      /* Contador */
      .question-counter {
        font-size: 1rem;
        color: var(--gray);
        font-weight: normal;
      }

      /* Responsividade */
      @media (max-width: 768px) {
        .selection-grid {
          grid-template-columns: 1fr;
        }

        .button-group {
          flex-direction: column;
        }

        .button {
          width: 100%;
        }
      }

      /* Elementos ocultos */
      .hidden {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Tela de Disciplinas -->
      <div id="disciplinas-screen">
        <h1>Escolha uma disciplina</h1>
        <div id="loading">Carregando...</div>
        <div id="error-message"></div>
        <div id="disciplinas" class="selection-grid"></div>
      </div>

      <!-- Tela de Subdisciplinas -->
      <div id="subdisciplinas-screen" class="hidden">
        <h2>Escolha uma subdisciplina</h2>
        <div id="subdisciplinas" class="selection-grid"></div>
        <div class="button-group">
          <button id="voltar-disciplinas" class="button-secondary">
            Voltar
          </button>
        </div>
      </div>

      <!-- Tela de Subcategorias -->
      <div id="subcategorias-screen" class="hidden">
        <h2>Escolha uma subcategoria</h2>
        <div id="subcategorias" class="selection-grid"></div>
        <div class="button-group">
          <button id="voltar-subdisciplinas" class="button-secondary">
            Voltar
          </button>
        </div>
      </div>

      <!-- Tela de Questões -->
      <div id="questao-screen" class="hidden">
        <div class="question-container">
          <h2>
            Questão <span class="question-counter" id="contador-questao"></span>
          </h2>
          <p class="question-text" id="enunciado"></p>
          <img
            id="imagem-questao"
            class="question-image hidden"
            alt="Imagem da questão"
          />
          <div class="options-container" id="alternativas"></div>
          <div class="button-group">
            <button id="voltar-subcategorias" class="button-secondary">
              Voltar
            </button>
            <button id="proxima" class="button-primary hidden">
              Próxima questão
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const apiBase = "http://localhost:3000/api";
      let questoes = [];
      let indiceQuestao = 0;
      let totalQuestoes = 0;
      let currentSubcategoriaId = null;

      // Elementos da interface
      const screens = {
        disciplinas: document.getElementById("disciplinas-screen"),
        subdisciplinas: document.getElementById("subdisciplinas-screen"),
        subcategorias: document.getElementById("subcategorias-screen"),
        questao: document.getElementById("questao-screen"),
      };

      function showError(message) {
        document.getElementById("error-message").textContent = message;
      }

      function clearError() {
        document.getElementById("error-message").textContent = "";
      }

      function showLoading(show) {
        document.getElementById("loading").style.display = show
          ? "block"
          : "none";
      }

      function showScreen(screenName) {
        Object.values(screens).forEach((screen) =>
          screen.classList.add("hidden")
        );
        screens[screenName].classList.remove("hidden");
      }

      // Carrega disciplinas
      async function fetchDisciplinas() {
        try {
          clearError();
          showLoading(true);
          const res = await fetch(`${apiBase}/disciplinas`);
          if (!res.ok) throw new Error("Falha ao carregar disciplinas");

          const data = await res.json();
          const div = document.getElementById("disciplinas");
          div.innerHTML = data
            .map(
              (d) => `
            <div class="selection-card" onclick="fetchSubdisciplinas(${d.id})">
              ${d.nome}
            </div>
          `
            )
            .join("");

          showScreen("disciplinas");
          showLoading(false);
        } catch (error) {
          showError(error.message);
          showLoading(false);
        }
      }

      // Carrega subdisciplinas
      async function fetchSubdisciplinas(disciplinaId) {
        try {
          clearError();
          showLoading(true);
          const res = await fetch(
            `${apiBase}/disciplinas/${disciplinaId}/subdisciplinas`
          );
          if (!res.ok) throw new Error("Falha ao carregar subdisciplinas");

          const data = await res.json();
          const div = document.getElementById("subdisciplinas");
          div.innerHTML = data
            .map(
              (s) => `
            <div class="selection-card" onclick="fetchSubcategorias(${s.id})">
              ${s.nome}
            </div>
          `
            )
            .join("");

          showScreen("subdisciplinas");
          showLoading(false);
        } catch (error) {
          showError(error.message);
          showLoading(false);
        }
      }

      // Carrega subcategorias
      async function fetchSubcategorias(subdisciplinaId) {
        try {
          clearError();
          showLoading(true);
          const res = await fetch(
            `${apiBase}/subdisciplinas/${subdisciplinaId}/subcategorias`
          );

          if (!res.ok) {
            // Se não houver subcategorias, busca questões diretamente
            return fetchQuestoes(subdisciplinaId);
          }

          const data = await res.json();

          if (data.length === 0) {
            // Se não houver subcategorias, busca questões diretamente
            return fetchQuestoes(subdisciplinaId);
          }

          const div = document.getElementById("subcategorias");
          div.innerHTML = data
            .map(
              (sc) => `
            <div class="selection-card" onclick="fetchQuestoes(${subdisciplinaId}, ${sc.id})">
              ${sc.nome}
            </div>
          `
            )
            .join("");

          showScreen("subcategorias");
          showLoading(false);
        } catch (error) {
          showError(error.message);
          showLoading(false);
        }
      }

      // Carrega questões
      async function fetchQuestoes(subdisciplinaId, subcategoriaId = null) {
        try {
          clearError();
          showLoading(true);

          let url = `${apiBase}/subdisciplinas/${subdisciplinaId}/questoes`;
          if (subcategoriaId) {
            url = `${apiBase}/subcategorias/${subcategoriaId}/questoes`;
            currentSubcategoriaId = subcategoriaId;
          } else {
            currentSubcategoriaId = null;
          }

          const res = await fetch(url);
          if (!res.ok) throw new Error("Falha ao carregar questões");

          questoes = await res.json();
          totalQuestoes = questoes.length;
          indiceQuestao = 0;

          if (questoes.length === 0) {
            throw new Error("Nenhuma questão disponível");
          }

          mostrarQuestao();
          showScreen("questao");
          showLoading(false);
        } catch (error) {
          showError(error.message);
          showLoading(false);
        }
      }

      function formatarEnunciado(texto) {
        // Primeiro substitui \n por <br>, depois divide por parágrafos
        return texto
          .replace(/\n/g, "<br>") // Substitui todas as quebras de linha por <br>
          .split("<br><br>") // Divide por parágrafos (duas quebras)
          .map((paragrafo) => {
            if (paragrafo.trim() === "") return "";
            return `<p>${paragrafo}</p>`;
          })
          .join("");
      }

      // Mostra questão atual
      function mostrarQuestao() {
        const q = questoes[indiceQuestao];
        if (!q) {
          document.getElementById("proxima").classList.add("hidden");
          alert("Fim das questões!");
          return;
        }

        // Debug: verifique se o enunciado completo está chegando
        console.log("Enunciado completo:", q.enunciado);

        // Usa innerHTML em vez de textContent
        document.getElementById("enunciado").innerHTML = formatarEnunciado(
          q.enunciado
        );
        document.getElementById("contador-questao").textContent = `${
          indiceQuestao + 1
        }/${totalQuestoes}`;

        const img = document.getElementById("imagem-questao");
        if (q.imagem) {
          img.src = q.imagem;
          img.classList.remove("hidden");
        } else {
          img.src = "";
          img.classList.add("hidden");
        }

        const altDiv = document.getElementById("alternativas");
        altDiv.innerHTML = "";
        const letras = ["a", "b", "c", "d", "e"];

        letras.forEach((letra) => {
          const texto = q[`alternativa_${letra}`];
          if (!texto) return;

          const btn = document.createElement("button");
          btn.className = "option";
          btn.setAttribute("data-letter", letra.toUpperCase());
          btn.innerHTML = `<span>${letra.toUpperCase()})</span> ${texto}`;
          btn.onclick = () =>
            responder(letra.toUpperCase(), q.resposta_correta, btn);
          altDiv.appendChild(btn);
        });

        document.getElementById("proxima").classList.add("hidden");
      }

      // Processa resposta
      function responder(escolhida, correta, botao) {
        const botoes = document.querySelectorAll(".option");
        botoes.forEach((b) => {
          b.disabled = true;
          if (b === botao) {
            b.classList.add(escolhida === correta ? "correct" : "incorrect");
          } else if (b.getAttribute("data-letter") === correta) {
            b.classList.add("correct");
          }
        });
        document.getElementById("proxima").classList.remove("hidden");
      }

      // Event listeners
      document.getElementById("proxima").addEventListener("click", () => {
        indiceQuestao++;
        mostrarQuestao();
      });

      document
        .getElementById("voltar-disciplinas")
        .addEventListener("click", () => {
          fetchDisciplinas();
        });

      document
        .getElementById("voltar-subdisciplinas")
        .addEventListener("click", () => {
          showScreen("subdisciplinas");
        });

      document
        .getElementById("voltar-subcategorias")
        .addEventListener("click", () => {
          if (currentSubcategoriaId) {
            showScreen("subcategorias");
          } else {
            showScreen("subdisciplinas");
          }
        });

      // Inicialização
      fetchDisciplinas();
    </script>
  </body>
</html>
